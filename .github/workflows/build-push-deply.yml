name: Build, Push to GAR, and Deploy to VM

on:
  ##push:
    ##branches: [ main ]
  workflow_dispatch: {}

env:
  REGION: ${{ secrets.GAR_LOCATION }}
  GAR_REPO: ${{ secrets.GAR_REPO }}
  IMAGE_NAME: ${{ secrets.IMAGE_NAME }}
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_ACCOUNT_EMAIL: ${{ secrets.SERVICE_ACCOUNT_EMAIL }}
  WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}

jobs:
  build-push:
    name: Build & Push to GAR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: auth
        name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT_EMAIL }}
          token_format: access_token
          create_credentials_file: true

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Docker auth to GAR
        run: |
          gcloud auth configure-docker "${REGION}-docker.pkg.dev" --quiet

      - id: meta
        name: Prepare image URIs
        run: |
          IMAGE_URI="${REGION}-docker.pkg.dev/${PROJECT_ID}/${GAR_REPO}/${IMAGE_NAME}:${GITHUB_SHA}"
          LATEST_URI="${REGION}-docker.pkg.dev/${PROJECT_ID}/${GAR_REPO}/${IMAGE_NAME}:latest"
          echo "image_uri=${IMAGE_URI}"  >> $GITHUB_OUTPUT
          echo "latest_uri=${LATEST_URI}" >> $GITHUB_OUTPUT
          echo "Building ${IMAGE_URI} and tagging ${LATEST_URI}"

      - name: Build & Push
        run: |
          docker build -t "${{ steps.meta.outputs.image_uri }}" .
          docker push "${{ steps.meta.outputs.image_uri }}"
          docker tag "${{ steps.meta.outputs.image_uri }}" "${{ steps.meta.outputs.latest_uri }}"
          docker push "${{ steps.meta.outputs.latest_uri }}"

  deploy:
    name: SSH deploy to VM
    needs: build-push
    runs-on: ubuntu-latest

    env:
      VM_HOST: ${{ vars.VM_HOST }}
      VM_USER: ${{ secrets.VM_USER }}
      VM_DEPLOY_DIR: ${{ vars.VM_DEPLOY_DIR }}
      VM_SSH_KEY: ${{ secrets.VM_SSH_KEY }}
      REGION: ${{ secrets.GAR_LOCATION }}
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4
        
      - name: Install ssh & scp
        run: sudo apt-get update && sudo apt-get install -y openssh-client

      - name: Add VM to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -T 30 -H "${VM_HOST}" >> ~/.ssh/known_hosts 2>/dev/null || echo "ssh-keyscan failed, continue"

      - name: Write SSH Private Key
        id: write_key
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "${{ env.VM_SSH_KEY }}" > ~/.ssh/id_deploy
          chmod 600 ~/.ssh/id_deploy
          echo "SSH key header:"
          head -2 ~/.ssh/id_deploy || true       

      - name: Test SSH connectivity
        run: |
          ssh -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no ${VM_USER}@${VM_HOST} "whoami && hostname && echo OK"

      - name: Generate .env locally
        env:
          ENV_POSTGRES_USER:        ${{ secrets.POSTGRES_USER }}
          ENV_POSTGRES_PASSWORD:    ${{ secrets.POSTGRES_PASSWORD }}
          ENV_POSTGRES_DB:          ${{ secrets.POSTGRES_DB }}
          ENV_AIRFLOW_USER:         ${{ secrets.AIRFLOW_USER }}
          ENV_AIRFLOW_PASSWORD:     ${{ secrets.AIRFLOW_PASSWORD }}
          ENV_AIRFLOW_FERNET_KEY:   ${{ secrets.FERNET_KEY}}
          ENV_WEBSERVER_SECRET_KEY: ${{ secrets.WEBSERVER_SECRET_KEY}}
          ENV_GCP_PROJECT_ID:       ${{ secrets.GCP_PROJECT_ID }}
          ENV_GCS_BUCKET:           ${{ secrets.GCS_BUCKET }}
          ENV_BQ_DATASET:           ${{ secrets.BQ_DATASET }}
          ENV_BQ_TABLE:             ${{ secrets.BQ_TABLE }}
          ENV_REGION:               ${{ secrets.GAR_LOCATION }}
          ENV_GAR_REPO:             ${{ secrets.GAR_REPO }}
          ENV_IMAGE_NAME:           ${{ secrets.IMAGE_NAME }}
        run: |
          AIRFLOW_IMAGE="${ENV_REGION}-docker.pkg.dev/${ENV_GCP_PROJECT_ID}/${ENV_GAR_REPO}/${ENV_IMAGE_NAME}:latest"

          {
            echo "POSTGRES_USER=${ENV_POSTGRES_USER}"
            echo "POSTGRES_PASSWORD=${ENV_POSTGRES_PASSWORD}"
            echo "POSTGRES_DB=${ENV_POSTGRES_DB}"
            echo "AIRFLOW_USER=${ENV_AIRFLOW_USER}"
            echo "AIRFLOW_PASSWORD=${ENV_AIRFLOW_PASSWORD}"
            echo "FERNET_KEY=${ENV_AIRFLOW_FERNET_KEY}"
            echo "WEBSERVER_SECRET_KEY"=${WEBSERVER_SECRET_KEY}
            echo "GCP_PROJECT_ID=${ENV_GCP_PROJECT_ID}"
            echo "GCS_BUCKET=${ENV_GCS_BUCKET}"
            echo "BQ_DATASET=${ENV_BQ_DATASET}"
            echo "BQ_TABLE=${ENV_BQ_TABLE}"
            echo "AIRFLOW_IMAGE=${AIRFLOW_IMAGE}"
          } > .env

          echo "Generated local .env:"
          sed 's/^\(POSTGRES_PASSWORD=\).*/\1****/; s/^\(AIRFLOW_PASSWORD=\).*/\1****/; s/^\(FERNET_KEY=\).*/\1****/' .env

      - name: Upload files to VM
        run: |
          ssh -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no ${VM_USER}@${VM_HOST} "mkdir -p ${VM_DEPLOY_DIR}"
          scp -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no .env ${VM_USER}@${VM_HOST}:${VM_DEPLOY_DIR}/.env
          scp -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no ./deploy.sh ${VM_USER}@${VM_HOST}:${VM_DEPLOY_DIR}/deploy.sh
          scp -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no ./docker-compose.yml ${VM_USER}@${VM_HOST}:${VM_DEPLOY_DIR}/docker-compose.yml

      - name: Run deploy.sh on VM
        run: |
          ssh -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no ${VM_USER}@${VM_HOST} "
            set -euo pipefail
            chmod +x ${VM_DEPLOY_DIR}/deploy.sh
            ${VM_DEPLOY_DIR}/deploy.sh
          "
