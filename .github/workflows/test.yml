name: test-ssh-login

on:
  workflow_dispatch: {}

jobs:
  test-ssh:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: Install ssh client
        run: sudo apt-get update && sudo apt-get install -y openssh-client

      - name: Write SSH private key to file
        env:
          VM_SSH_KEY: ${{ secrets.VM_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$VM_SSH_KEY" > ~/.ssh/id_deploy
          chmod 600 ~/.ssh/id_deploy

          echo "=== Debug: key header & file type ==="
          head -1 ~/.ssh/id_deploy || true
          file ~/.ssh/id_deploy || true

      - name: Test SSH connectivity to VM
        env:
          VM_HOST: ${{ secrets.VM_HOST }}
          VM_USER: ${{ secrets.VM_USER }}
        run: |
          echo "Testing SSH to ${VM_USER}@${VM_HOST} ..."
          ssh -vvv \
            -i ~/.ssh/id_deploy \
            -o StrictHostKeyChecking=no \
            -o BatchMode=yes \
            "${VM_USER}@${VM_HOST}" \
            "whoami && hostname && echo OK"
